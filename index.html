<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apotek Alpro National Day 2025 - Dashboard</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #ffffff 100%);
        }
        
        .medal-podium {
            perspective: 1000px;
        }
        
        .medal-card {
            transform-style: preserve-3d;
            transition: transform 0.3s;
        }
        
        .medal-card:hover {
            transform: rotateY(5deg) scale(1.05);
        }
        
        .gold { background: linear-gradient(45deg, #ffd700, #ffed4a); }
        .silver { background: linear-gradient(45deg, #c0c0c0, #e2e8f0); }
        .bronze { background: linear-gradient(45deg, #cd7f32, #d69e2e); }
        
        .outlet-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .outlet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .animate-pulse-slow {
            animation: pulse 3s infinite;
        }
        
        @keyframes countUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .count-up {
            animation: countUp 0.6s ease-out;
        }
        
        .day-badge {
            min-width: 80px;
            min-height: 60px;
        }
        
        .performance-excellent { border-left-color: #10b981; }
        .performance-good { border-left-color: #3b82f6; }
        .performance-average { border-left-color: #f59e0b; }
        .performance-poor { border-left-color: #ef4444; }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-clinic-medical text-4xl text-red-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-900">Apotek Alpro</h1>
                <p class="text-gray-600">National Day 2025 Dashboard</p>
                <p class="text-sm text-gray-500 mt-2">9-18 Agustus 2025</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                           placeholder="your.email@apotekalpro.id">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                           placeholder="Enter your password">
                </div>
                
                <button type="submit" id="loginBtn"
                        class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition duration-200 font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    <span id="loginBtnText">Login</span>
                    <div id="loginSpinner" class="loading-spinner mx-auto hidden" style="width: 20px; height: 20px;"></div>
                </button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-clinic-medical text-2xl text-red-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Apotek Alpro National Day 2025</h1>
                            <p class="text-gray-600 text-sm">9-18 Agustus 2025</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="refreshData()" class="text-blue-600 hover:text-blue-800" title="Refresh Data">
                            <i class="fas fa-sync-alt text-xl" id="refreshIcon"></i>
                        </button>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Welcome,</p>
                            <p class="font-semibold text-gray-900" id="userName"></p>
                            <p class="text-xs text-gray-500" id="userRole"></p>
                        </div>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loadingState" class="container mx-auto px-4 py-8">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Loading dashboard data...</p>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="container mx-auto px-4 py-8 hidden">
            <!-- National Progress Section -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Countdown -->
                        <div class="text-center">
                            <div class="bg-red-600 text-white rounded-lg p-4">
                                <i class="fas fa-clock text-2xl mb-2"></i>
                                <h3 class="font-bold text-lg">Countdown</h3>
                                <div id="countdown" class="text-2xl font-bold"></div>
                            </div>
                        </div>
                        
                        <!-- National Target -->
                        <div class="text-center">
                            <h4 class="text-lg font-semibold mb-2">Total Target (10 Days)</h4>
                            <p class="text-2xl font-bold text-red-600">Rp 12.000.000.000</p>
                            <p class="text-sm text-gray-600">Daily: Rp 1.200.000.000</p>
                        </div>
                        
                        <!-- Current Achievement -->
                        <div class="text-center">
                            <h4 class="text-lg font-semibold mb-2">Current Achievement</h4>
                            <p class="text-2xl font-bold text-green-600" id="currentAchievement">Rp 0</p>
                            <p class="text-sm text-gray-600" id="achievementPercent">0.0%</p>
                        </div>
                        
                        <!-- Incentive Status -->
                        <div class="text-center">
                            <h4 class="text-lg font-semibold mb-2">Incentive Status</h4>
                            <div class="relative">
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="incentiveProgress" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <p class="text-sm mt-2" id="incentiveStatus">LOCKED (Need 90%)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medal Leaderboards -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">üèÜ Medal Leaderboards</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Top 5 Outlets by Achievement % -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-center mb-4">Top 5 Outlets by Achievement %</h3>
                        <div id="topOutletsByPercent" class="space-y-4"></div>
                    </div>
                    
                    <!-- Top 5 Outlets by Sales -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-center mb-4">Top 5 Outlets by Sales</h3>
                        <div id="topOutletsBySales" class="space-y-4"></div>
                    </div>
                    
                    <!-- Top 3 Area Managers -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-center mb-4">Top 3 Area Managers</h3>
                        <div id="topAreaManagers" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Incentive System -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-center mb-4">üí∞ Incentive System</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-bold text-green-800 mb-2">Level 1 (‚â•100%)</h4>
                            <ul class="text-sm text-green-700">
                                <li>‚Ä¢ Outlet: 2% dari sales</li>
                                <li>‚Ä¢ AM: 0.2% dari total sales area</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 mb-2">Level 2 (90-99.99%)</h4>
                            <ul class="text-sm text-blue-700">
                                <li>‚Ä¢ Outlet: 1% dari sales</li>
                                <li>‚Ä¢ AM: 0.1% dari total sales area</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-exclamation-triangle text-orange-500"></i>
                            Syarat: Target nasional minimal 90% untuk unlock incentive
                        </p>
                    </div>
                </div>
            </div>

            <!-- Outlet Performance Section -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 md:mb-0">Outlet Performance Tracker</h3>
                        
                        <div class="flex flex-col md:flex-row gap-4">
                            <select id="amFilter" class="px-4 py-2 border rounded-lg">
                                <option value="">All Area Managers</option>
                            </select>
                            
                            <input type="text" id="searchOutlet" placeholder="Search outlet..." 
                                   class="px-4 py-2 border rounded-lg">
                        </div>
                    </div>
                    
                    <div id="outletGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"></div>
                    
                    <!-- Pagination -->
                    <div class="flex justify-center items-center space-x-4">
                        <button id="prevPage" onclick="changePage(-1)" 
                                class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 disabled:opacity-50">
                            Previous
                        </button>
                        <span id="pageInfo" class="text-gray-600"></span>
                        <button id="nextPage" onclick="changePage(1)" 
                                class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 disabled:opacity-50">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Performers Alert -->
            <div class="mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Bottom 10 Outlets -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-red-800 mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                            Bottom 10 Outlets - Need Improvement
                        </h3>
                        <div id="bottomOutlets" class="space-y-3"></div>
                        <div class="mt-4 text-sm text-red-700">
                            <p><i class="fas fa-lightbulb"></i> Focus on daily target achievement and customer engagement!</p>
                        </div>
                    </div>
                    
                    <!-- Bottom 3 Area Managers -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-orange-800 mb-4">
                            <i class="fas fa-chart-line"></i>
                            Bottom 3 Area Managers - Strategic Focus
                        </h3>
                        <div id="bottomAMs" class="space-y-3"></div>
                        <div class="mt-4 text-sm text-orange-700">
                            <p><i class="fas fa-users"></i> Review regional strategy and support outlet teams!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">Daily National Progress</h3>
                        <div style="height: 300px;">
                            <canvas id="dailyProgressChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">Area Manager Performance</h3>
                        <div style="height: 300px;">
                            <canvas id="amChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 15;
        let filteredOutlets = [];
        let allUsers = [];
        let allOutlets = [];
        let allAMs = [];
        let grandTotalData = null;
        let dailyProgressChart = null;
        let amChart = null;

        // Embedded login data
        const EMBEDDED_USERS = [
            { name: "ENI KHUZAIMAH", email: "eni.khuzaimah@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "ADE IRMA SEPTIANI AIDHA", email: "ade.irma@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "APRIANA LUMBAN GAOL", email: "apriana.gaol@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "NARTA LENA GINTING", email: "narta.lena@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "HANNA DOLI BR KABAN", email: "hanna.doli@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "JESIKA SILITONGA", email: "jesika.silitonga@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "LINDA NOVAWATI SIHOMBING", email: "linda.sihombing@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "CAMELIA FITRIANI", email: "camelia.fitriani@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "ISMA LESTARI", email: "Isma.lestari@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "NUR ADE ARYANI", email: "nurade.aryani@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "PUTRI WULANDARI", email: "putri.wulandari@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "SITI NURLAILA", email: "siti.nurlaila@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "FUNNA ANINDYA", email: "funna.anindya@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "JULAINI", email: "Julaini@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "SANTI FARIDA YANTI", email: "santi.faridayanti@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "JEPPARIA M SIREGAR", email: "jepparia.siregar@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "LELIANA OKTAVIA SARAGIH", email: "leli.saragih@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "GENY SARASWATI", email: "geny.saraswati@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "BAID SION BR. SINAGA", email: "baid.sion@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "SANNAULI SIAHAAN", email: "sanna.siahaan@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "TOMAS", email: "khoo.ziyu@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "BERNARD", email: "bernard.lee@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "EUGENNE", email: "teo.yinghui@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "YC", email: "yinchen@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "LESTY", email: "rupa.lesty@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "ANTO", email: "tarjo.susianto@apotekalpro.id", status: "Active", role: "BPT", password: "Alpro@123" },
            { name: "SUWAHYU", email: "suwahyu@apotekalpro.id", status: "Active", role: "OPERATION", password: "Alpro@123" },
            { name: "DEVI", email: "devi.purba@apotekalpro.id", status: "Active", role: "STRATEGY", password: "Alpro@123" }
        ];

        // Google Sheets configuration
        const PERFORMANCE_SHEET_ID = '1TkquW9OszwyWSa-ett8hvGe9JgDdgNtX';

        function getPerformanceSheetUrl() {
            return `https://docs.google.com/spreadsheets/d/${PERFORMANCE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Update Daily Performance`;
        }

        function getAMPivotSheetUrl() {
            return `https://docs.google.com/spreadsheets/d/${PERFORMANCE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Pivot Target AM`;
        }

        // Parse CSV utility
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim().replace(/^"/, '').replace(/"$/, ''));
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    row.push(current.trim().replace(/^"/, '').replace(/"$/, ''));
                    rows.push(row);
                }
            }
            return rows;
        }

        // Parse Indonesian number format (. = thousands, , = decimal)
        function parseIndonesianNumber(value) {
            if (!value || value === '' || value === '-') return 0;
            
            // Clean the value - remove quotes and spaces
            let cleanValue = String(value).replace(/['"]/g, '').trim();
            
            // If it contains both . and , then . is thousands separator
            if (cleanValue.includes('.') && cleanValue.includes(',')) {
                // Format like 1.234.567,89
                cleanValue = cleanValue.replace(/\./g, '').replace(',', '.');
            } else if (cleanValue.includes('.')) {
                // Could be thousands (1.234.567) or decimal (1.23)
                // Count dots - if more than 1, it's thousands separator
                const dotCount = (cleanValue.match(/\./g) || []).length;
                if (dotCount > 1 || cleanValue.length > 6) {
                    // Thousands separator: 1.234.567 or 1.234
                    cleanValue = cleanValue.replace(/\./g, '');
                }
                // Otherwise it's decimal (1.23) - keep as is
            }
            
            const numValue = parseFloat(cleanValue);
            return isNaN(numValue) ? 0 : numValue;
        }

        // Format number for Indonesian display
        function formatIndonesianRupiah(amount) {
            if (amount === 0) return 'Rp 0';
            
            // Format with periods as thousands separators
            return 'Rp ' + Math.round(amount).toLocaleString('de-DE');
        }

        async function fetchPerformanceData() {
            try {
                console.log('Fetching performance data...');
                const response = await fetch(getPerformanceSheetUrl());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                const rows = parseCSV(text);
                
                const outlets = [];
                let grandTotalRow = null;
                
                // Find Grand Total row and parse outlet data
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length >= 6 && row[0]) {
                        // Check if this is Grand Total row
                        if (row[0].toLowerCase().includes('grand total')) {
                            grandTotalRow = row;
                            console.log('Found Grand Total row:', grandTotalRow);
                            continue;
                        }
                        
                        if (row[0].trim() !== '') {
                            const outlet = {
                                outlet: row[0] || '',
                                name: row[1] || '',
                                am: row[2] || '',
                                totalTarget: parseIndonesianNumber(row[3]), // D = Total target 10 days
                                dailyTarget: parseIndonesianNumber(row[4])  // E = Daily target
                            };
                            
                            // Parse daily sales and percentages
                            // F=D1 sales, G=D1%, H=D2 sales, I=D2%, etc.
                            for (let day = 1; day <= 10; day++) {
                                const salesColIndex = 4 + (day * 2) - 1; // F=5, H=7, J=9, etc.
                                const percentColIndex = salesColIndex + 1;  // G=6, I=8, K=10, etc.
                                
                                outlet[`d${day}Sales`] = parseIndonesianNumber(row[salesColIndex]);
                                outlet[`d${day}Percent`] = parseIndonesianNumber(row[percentColIndex]);
                            }
                            
                            outlets.push(outlet);
                        }
                    }
                }
                
                // Store Grand Total data globally
                grandTotalData = grandTotalRow;
                
                console.log(`Loaded ${outlets.length} outlets`);
                return outlets;
                
            } catch (error) {
                console.error('Error fetching performance data:', error);
                return [];
            }
        }

        async function fetchAMData() {
            try {
                console.log('Fetching AM data...');
                const response = await fetch(getAMPivotSheetUrl());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                const rows = parseCSV(text);
                
                const ams = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length >= 4 && row[0] && row[0].trim() !== '') {
                        const am = {
                            name: row[0] || '',
                            totalTarget: parseIndonesianNumber(row[1]) // B = Total 10 days target
                        };
                        
                        // Parse daily sales D=D1, E=D2, etc.
                        let totalSales = 0;
                        for (let day = 1; day <= 10; day++) {
                            const salesColIndex = 2 + day; // D=3, E=4, F=5, etc.
                            const daySales = parseIndonesianNumber(row[salesColIndex]);
                            am[`d${day}Sales`] = daySales;
                            totalSales += daySales;
                        }
                        
                        am.totalSales = totalSales;
                        am.achievementPercent = am.totalTarget > 0 ? (totalSales / am.totalTarget) : 0;
                        
                        ams.push(am);
                    }
                }
                
                console.log(`Loaded ${ams.length} AMs`);
                return ams;
                
            } catch (error) {
                console.error('Error fetching AM data:', error);
                return [];
            }
        }

        // Login Functions
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            loginBtnText.textContent = 'Signing in...';
            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;
            
            try {
                allUsers = EMBEDDED_USERS;
                
                const user = allUsers.find(u => 
                    u.email.toLowerCase().trim() === email.toLowerCase().trim() && 
                    u.password === password && 
                    u.status.toLowerCase() === 'active'
                );
                
                if (user) {
                    currentUser = user;
                    showDashboard();
                } else {
                    showLoginError('Invalid email or password. Please check your credentials.');
                }
            } catch (error) {
                showLoginError('Error connecting to server. Please try again.');
                console.error('Login error:', error);
            }
            
            loginBtnText.textContent = 'Login';
            loginSpinner.classList.add('hidden');
            loginBtn.disabled = false;
        });

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        async function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            
            await initializeDashboard();
        }

        function logout() {
            currentUser = null;
            allUsers = [];
            allOutlets = [];
            allAMs = [];
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        async function initializeDashboard() {
            try {
                allOutlets = await fetchPerformanceData();
                allAMs = await fetchAMData();
                filteredOutlets = [...allOutlets];
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                
                startCountdown();
                updateNationalProgress();
                updateMedalLeaderboards();
                populateFilters();
                updateOutletDisplay();
                updateBottomPerformers();
                initializeCharts();
                
                setInterval(refreshData, 30000);
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('loadingState').innerHTML = 
                    '<div class="text-center"><p class="text-red-600">Error loading data. Please refresh the page.</p></div>';
            }
        }

        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('animate-spin');
            
            try {
                const newOutlets = await fetchPerformanceData();
                const newAMs = await fetchAMData();
                if (newOutlets.length > 0) {
                    allOutlets = newOutlets;
                    allAMs = newAMs;
                    applyFilters();
                    updateNationalProgress();
                    updateMedalLeaderboards();
                    updateBottomPerformers();
                    updateCharts();
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
            
            refreshIcon.classList.remove('animate-spin');
        }

        function startCountdown() {
            const targetDate = new Date('2025-08-18T23:59:59').getTime();
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = targetDate - now;
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').innerHTML = 
                    `${days}d ${hours}h ${minutes}m ${seconds}s`;
                
                if (distance < 0) {
                    document.getElementById('countdown').innerHTML = "CAMPAIGN ENDED";
                }
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function updateNationalProgress() {
            let totalAchievement = 0;
            const totalTarget = 12000000000;
            
            // Use Grand Total row data if available
            if (grandTotalData && grandTotalData.length > 0) {
                // Sum F,H,J,L,N,P,R,T,V,X from Grand Total row
                for (let day = 1; day <= 10; day++) {
                    const salesColIndex = 4 + (day * 2) - 1; // F=5, H=7, J=9, etc.
                    totalAchievement += parseIndonesianNumber(grandTotalData[salesColIndex]);
                }
            } else {
                // Fallback: sum all outlet sales
                allOutlets.forEach(outlet => {
                    for (let day = 1; day <= 10; day++) {
                        totalAchievement += outlet[`d${day}Sales`] || 0;
                    }
                });
            }
            
            console.log('Total national achievement:', totalAchievement);
            
            const achievementPercent = (totalAchievement / totalTarget) * 100;
            const incentiveProgress = Math.min(achievementPercent / 90 * 100, 100);
            
            document.getElementById('currentAchievement').textContent = formatIndonesianRupiah(totalAchievement);
            document.getElementById('achievementPercent').textContent = `${achievementPercent.toFixed(1)}%`;
            document.getElementById('incentiveProgress').style.width = `${incentiveProgress}%`;
            
            if (achievementPercent >= 90) {
                document.getElementById('incentiveStatus').textContent = 'UNLOCKED!';
                document.getElementById('incentiveStatus').className = 'text-sm mt-2 text-green-600 font-bold';
            } else {
                document.getElementById('incentiveStatus').textContent = `LOCKED (Need ${(90 - achievementPercent).toFixed(1)}% more)`;
                document.getElementById('incentiveStatus').className = 'text-sm mt-2 text-red-600';
            }
        }

        function updateMedalLeaderboards() {
            // Top 5 Outlets by Achievement % (using D1 % from column G)
            const outletsByPercent = [...allOutlets]
                .filter(outlet => outlet.d1Percent > 0)
                .sort((a, b) => b.d1Percent - a.d1Percent)
                .slice(0, 5);

            const percentContainer = document.getElementById('topOutletsByPercent');
            percentContainer.innerHTML = outletsByPercent.map((outlet, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                const colors = ['gold', 'silver', 'bronze', 'bg-blue-100', 'bg-green-100'];
                return `
                    <div class="medal-card ${colors[index]} p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">${medals[index]}</div>
                        <h4 class="font-bold text-sm">${outlet.name}</h4>
                        <p class="text-xs text-gray-600">${outlet.am}</p>
                        <p class="text-lg font-bold">${outlet.d1Percent.toFixed(1)}%</p>
                    </div>
                `;
            }).join('');

            // Top 5 Outlets by Sales (using D1 sales from column F)
            const outletsBySales = [...allOutlets]
                .filter(outlet => outlet.d1Sales > 0)
                .sort((a, b) => b.d1Sales - a.d1Sales)
                .slice(0, 5);

            const salesContainer = document.getElementById('topOutletsBySales');
            salesContainer.innerHTML = outletsBySales.map((outlet, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                const colors = ['gold', 'silver', 'bronze', 'bg-blue-100', 'bg-green-100'];
                return `
                    <div class="medal-card ${colors[index]} p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">${medals[index]}</div>
                        <h4 class="font-bold text-sm">${outlet.name}</h4>
                        <p class="text-xs text-gray-600">${outlet.am}</p>
                        <p class="text-sm font-bold">${formatIndonesianRupiah(outlet.d1Sales)}</p>
                    </div>
                `;
            }).join('');

            // Top 3 Area Managers (from Pivot Target AM sheet)
            const topAMs = [...allAMs]
                .sort((a, b) => b.achievementPercent - a.achievementPercent)
                .slice(0, 3);

            const amContainer = document.getElementById('topAreaManagers');
            amContainer.innerHTML = topAMs.map((am, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const colors = ['gold', 'silver', 'bronze'];
                return `
                    <div class="medal-card ${colors[index]} p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">${medals[index]}</div>
                        <h4 class="font-bold text-sm">${am.name}</h4>
                        <p class="text-lg font-bold">${(am.achievementPercent * 100).toFixed(1)}%</p>
                        <p class="text-xs">${formatIndonesianRupiah(am.totalSales)}</p>
                    </div>
                `;
            }).join('');
        }

        function populateFilters() {
            const amFilter = document.getElementById('amFilter');
            const uniqueAMs = [...new Set(allOutlets.map(outlet => outlet.am))].filter(am => am);
            
            amFilter.innerHTML = '<option value="">All Area Managers</option>' +
                uniqueAMs.map(am => `<option value="${am}">${am}</option>`).join('');

            document.getElementById('amFilter').addEventListener('change', applyFilters);
            document.getElementById('searchOutlet').addEventListener('input', applyFilters);
        }

        function applyFilters() {
            const amFilter = document.getElementById('amFilter').value;
            const searchTerm = document.getElementById('searchOutlet').value.toLowerCase();

            filteredOutlets = allOutlets.filter(outlet => {
                const amMatch = !amFilter || outlet.am === amFilter;
                const searchMatch = !searchTerm || 
                    outlet.name.toLowerCase().includes(searchTerm) || 
                    outlet.outlet.toLowerCase().includes(searchTerm);
                
                return amMatch && searchMatch;
            });

            currentPage = 1;
            updateOutletDisplay();
        }

        function updateOutletDisplay() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageOutlets = filteredOutlets.slice(start, end);

            const outletGrid = document.getElementById('outletGrid');
            outletGrid.innerHTML = pageOutlets.map(outlet => createOutletCard(outlet)).join('');

            updatePagination();
        }

        function createOutletCard(outlet) {
            // Calculate total sales from F,H,J,L,N,P,R,T,V,X
            let totalSales = 0;
            let totalPercent = 0;
            let activeDays = 0;
            
            for (let day = 1; day <= 10; day++) {
                totalSales += outlet[`d${day}Sales`] || 0;
                if (outlet[`d${day}Percent`] > 0) {
                    totalPercent += outlet[`d${day}Percent`];
                    activeDays++;
                }
            }
            
            const avgAchievement = activeDays > 0 ? totalPercent / activeDays : 0;
            
            const performanceClass = avgAchievement >= 100 ? 'performance-excellent' : 
                                   avgAchievement >= 90 ? 'performance-good' : 
                                   avgAchievement >= 70 ? 'performance-average' : 'performance-poor';

            return `
                <div class="outlet-card ${performanceClass} bg-white rounded-lg shadow-lg p-4">
                    <div class="mb-3">
                        <h4 class="font-bold text-sm text-gray-900">${outlet.name}</h4>
                        <p class="text-xs text-gray-600">${outlet.outlet}</p>
                        <p class="text-xs text-gray-600">${outlet.am}</p>
                    </div>
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        ${[1,2,3,4,5].map(day => {
                            const sales = outlet[`d${day}Sales`] || 0;
                            const percent = outlet[`d${day}Percent`] || 0;
                            const isActive = sales > 0;
                            return `
                                <div class="day-badge ${isActive ? 'bg-blue-100 border-blue-300' : 'bg-gray-100 border-gray-300'} 
                                           border rounded-lg p-2 text-center">
                                    <div class="text-xs font-semibold">D${day}</div>
                                    <div class="text-xs ${isActive ? 'text-blue-700' : 'text-gray-500'}">
                                        ${isActive ? `${percent.toFixed(1)}%` : '-'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        ${[6,7,8,9,10].map(day => {
                            const sales = outlet[`d${day}Sales`] || 0;
                            const percent = outlet[`d${day}Percent`] || 0;
                            const isActive = sales > 0;
                            return `
                                <div class="day-badge ${isActive ? 'bg-blue-100 border-blue-300' : 'bg-gray-100 border-gray-300'} 
                                           border rounded-lg p-2 text-center">
                                    <div class="text-xs font-semibold">D${day}</div>
                                    <div class="text-xs ${isActive ? 'text-blue-700' : 'text-gray-500'}">
                                        ${isActive ? `${percent.toFixed(1)}%` : '-'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="border-t pt-3 mt-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Total Sales:</span>
                            <span class="font-semibold text-green-600">${formatIndonesianRupiah(totalSales)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Avg Achievement:</span>
                            <span class="font-semibold ${avgAchievement >= 100 ? 'text-green-600' : avgAchievement >= 90 ? 'text-blue-600' : 'text-orange-600'}">
                                ${avgAchievement > 0 ? avgAchievement.toFixed(1) + '%' : '-'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredOutlets.length / itemsPerPage);
            
            document.getElementById('pageInfo').textContent = 
                `Page ${currentPage} of ${totalPages} (${filteredOutlets.length} outlets)`;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredOutlets.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updateOutletDisplay();
            }
        }

        function updateBottomPerformers() {
            // Bottom 10 Outlets
            const outletsByPerformance = [...allOutlets]
                .map(outlet => {
                    let totalPercent = 0;
                    let activeDays = 0;
                    
                    for (let day = 1; day <= 10; day++) {
                        if (outlet[`d${day}Percent`] > 0) {
                            totalPercent += outlet[`d${day}Percent`];
                            activeDays++;
                        }
                    }
                    
                    return {
                        ...outlet,
                        avgPercent: activeDays > 0 ? totalPercent / activeDays : 0
                    };
                })
                .sort((a, b) => a.avgPercent - b.avgPercent)
                .slice(0, 10);

            const bottomOutletsContainer = document.getElementById('bottomOutlets');
            bottomOutletsContainer.innerHTML = outletsByPerformance.map(outlet => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-red-200">
                    <div>
                        <h5 class="font-semibold text-sm">${outlet.name}</h5>
                        <p class="text-xs text-gray-600">${outlet.am}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-red-600">${outlet.avgPercent > 0 ? outlet.avgPercent.toFixed(1) + '%' : 'No data'}</p>
                    </div>
                </div>
            `).join('');

            // Bottom 3 AMs
            const bottomAMs = [...allAMs]
                .sort((a, b) => a.achievementPercent - b.achievementPercent)
                .slice(0, 3);

            const bottomAMsContainer = document.getElementById('bottomAMs');
            bottomAMsContainer.innerHTML = bottomAMs.map(am => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-orange-200">
                    <div>
                        <h5 class="font-semibold text-sm">${am.name}</h5>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-orange-600">${(am.achievementPercent * 100).toFixed(1)}%</p>
                        <p class="text-xs text-gray-500">${formatIndonesianRupiah(am.totalSales)}</p>
                    </div>
                </div>
            `).join('');
        }

        function initializeCharts() {
            // Daily Progress Chart
            const dailyCtx = document.getElementById('dailyProgressChart').getContext('2d');
            const dailyData = new Array(10).fill(0);
            
            for (let day = 1; day <= 10; day++) {
                allOutlets.forEach(outlet => {
                    dailyData[day - 1] += outlet[`d${day}Sales`] || 0;
                });
            }

            dailyProgressChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: ['D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'D9', 'D10'],
                    datasets: [{
                        label: 'Daily Achievement',
                        data: dailyData,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Daily Target',
                        data: Array(10).fill(1200000000),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });

            // Area Manager Performance Chart
            const amCtx = document.getElementById('amChart').getContext('2d');
            
            amChart = new Chart(amCtx, {
                type: 'doughnut',
                data: {
                    labels: allAMs.map(am => am.name),
                    datasets: [{
                        data: allAMs.map(am => am.totalSales),
                        backgroundColor: [
                            '#dc2626', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6',
                            '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#ec4899'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (dailyProgressChart) {
                const dailyData = new Array(10).fill(0);
                for (let day = 1; day <= 10; day++) {
                    allOutlets.forEach(outlet => {
                        dailyData[day - 1] += outlet[`d${day}Sales`] || 0;
                    });
                }
                dailyProgressChart.data.datasets[0].data = dailyData;
                dailyProgressChart.update();
            }

            if (amChart) {
                amChart.data.labels = allAMs.map(am => am.name);
                amChart.data.datasets[0].data = allAMs.map(am => am.totalSales);
                amChart.update();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Always show login page on load
        });
    </script>

</body>
</html>
