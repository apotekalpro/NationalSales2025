<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apotek Alpro National Day 2025 - Dashboard</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #ffffff 100%);
        }
        
        .medal-podium {
            perspective: 1000px;
        }
        
        .medal-card {
            transform-style: preserve-3d;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .medal-card:hover {
            transform: rotateY(5deg) scale(1.05) translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .gold { 
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 50%, #f59e0b 100%);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }
        .silver { 
            background: linear-gradient(135deg, #c0c0c0 0%, #e2e8f0 50%, #94a3b8 100%);
            box-shadow: 0 8px 25px rgba(192, 192, 192, 0.3);
        }
        .bronze { 
            background: linear-gradient(135deg, #cd7f32 0%, #d69e2e 50%, #92400e 100%);
            box-shadow: 0 8px 25px rgba(205, 127, 50, 0.3);
        }
        
        .outlet-card {
            transition: all 0.4s ease;
            border-left: 4px solid transparent;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .outlet-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .animate-pulse-slow {
            animation: pulse 3s infinite;
        }
        
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(220, 38, 38, 0.3); }
            to { box-shadow: 0 0 30px rgba(220, 38, 38, 0.6); }
        }
        
        @keyframes countUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .count-up {
            animation: countUp 0.6s ease-out;
        }
        
        .day-badge {
            min-width: 80px;
            min-height: 60px;
            transition: all 0.3s ease;
        }
        
        .day-badge:hover {
            transform: scale(1.1);
        }
        
        .performance-excellent { 
            border-left-color: #10b981;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1);
        }
        .performance-good { 
            border-left-color: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
        }
        .performance-average { 
            border-left-color: #f59e0b;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
        }
        .performance-poor { 
            border-left-color: #ef4444;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1);
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card-enhanced {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        
        .progress-bar-animated {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
            background-size: 200% 100%;
            animation: progressFlow 2s ease-in-out infinite;
        }
        
        @keyframes progressFlow {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .daily-tracker {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 50%, #1e3a8a 100%);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .am-table {
            font-size: 0.8rem;
        }
        
        .am-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-weight: 600;
            text-align: center;
            padding: 8px 4px;
            border: 1px solid #e5e7eb;
        }
        
        .am-table td {
            padding: 6px 4px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .am-table .am-name {
            text-align: left;
            font-weight: 600;
            min-width: 120px;
        }
        
        .am-table .target-col {
            background-color: #fef3c7;
        }
        
        .am-table .achievement-col {
            font-weight: 700;
        }
        
        .achievement-excellent { background-color: #d1fae5; color: #065f46; }
        .achievement-good { background-color: #dbeafe; color: #1e40af; }
        .achievement-average { background-color: #fef3c7; color: #92400e; }
        .achievement-poor { background-color: #fecaca; color: #991b1b; }
        
        .day-sales-cell {
            min-width: 70px;
            font-size: 0.7rem;
        }
        
        @media (max-width: 768px) {
            .am-table {
                font-size: 0.6rem;
            }
            .day-sales-cell {
                min-width: 50px;
                font-size: 0.6rem;
            }
            .am-table th, .am-table td {
                padding: 4px 2px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-red-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-clinic-medical text-4xl text-red-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Apotek Alpro</h1>
                <p class="text-gray-600 font-medium">National Day 2025 Dashboard</p>
                <p class="text-sm text-gray-500 mt-2 font-semibold">9-18 Agustus 2025</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                           placeholder="your.email@apotekalpro.id">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                           placeholder="Enter your password">
                </div>
                
                <button type="submit" id="loginBtn"
                        class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-xl hover:from-red-700 hover:to-red-800 transition duration-300 font-semibold shadow-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    <span id="loginBtnText">Login</span>
                    <div id="loginSpinner" class="loading-spinner mx-auto hidden" style="width: 20px; height: 20px;"></div>
                </button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden bg-red-50 p-3 rounded-lg"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="bg-red-100 rounded-full w-12 h-12 flex items-center justify-center">
                            <i class="fas fa-clinic-medical text-2xl text-red-600"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-red-600 to-red-800 bg-clip-text text-transparent">
                                Apotek Alpro National Day 2025
                            </h1>
                            <p class="text-gray-600 text-sm font-medium">9-18 Agustus 2025 ‚Ä¢ Live Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <button onclick="refreshData()" class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-all duration-200" title="Refresh Data">
                            <i class="fas fa-sync-alt text-xl" id="refreshIcon"></i>
                        </button>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Welcome back,</p>
                            <p class="font-bold text-gray-900" id="userName"></p>
                            <p class="text-xs text-blue-600 font-medium" id="userRole"></p>
                        </div>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition-all duration-200">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loadingState" class="container mx-auto px-4 py-8">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">Loading dashboard data...</p>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="container mx-auto px-4 py-8 hidden">
            <!-- Daily Progress Tracker -->
            <div class="mb-8">
                <div class="daily-tracker text-white rounded-2xl shadow-2xl p-8">
                    <div class="text-center mb-6">
                        <i class="fas fa-calendar-day text-3xl mb-3"></i>
                        <h2 class="text-2xl font-bold">Daily Progress Tracker</h2>
                        <p class="text-blue-100">Today's Performance vs Daily Target</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div>
                            <h3 class="text-lg font-semibold mb-2" id="currentDayLabel">Day 1 (Aug 9)</h3>
                            <p class="text-3xl font-bold" id="dailyAchievement">Rp 0</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Daily Target</h3>
                            <p class="text-3xl font-bold">Rp 1.200.000.000</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Achievement</h3>
                            <p class="text-3xl font-bold" id="dailyPercent">0.0%</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="w-full bg-blue-800 rounded-full h-4">
                            <div id="dailyProgress" class="progress-bar-animated h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- National Progress Section -->
            <div class="mb-8">
                <div class="card-enhanced rounded-2xl shadow-2xl p-8">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <!-- Countdown -->
                        <div class="text-center">
                            <div class="bg-gradient-to-br from-red-600 to-red-700 text-white rounded-xl p-6 glow">
                                <i class="fas fa-clock text-3xl mb-3"></i>
                                <h3 class="font-bold text-lg mb-2">Countdown</h3>
                                <div id="countdown" class="text-2xl font-bold count-up"></div>
                            </div>
                        </div>
                        
                        <!-- National Target -->
                        <div class="text-center">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Total Target (10 Days)</h4>
                            <p class="text-3xl font-bold text-red-600 mb-2">Rp 12.000.000.000</p>
                            <p class="text-sm text-gray-600 bg-gray-100 rounded-lg px-3 py-1 inline-block">Daily: Rp 1.200.000.000</p>
                        </div>
                        
                        <!-- Current Achievement -->
                        <div class="text-center">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Current Achievement</h4>
                            <p class="text-3xl font-bold text-green-600 count-up" id="currentAchievement">Rp 0</p>
                            <p class="text-sm text-gray-600 font-medium" id="achievementPercent">0.0%</p>
                        </div>
                        
                        <!-- Incentive Status -->
                        <div class="text-center">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Incentive Status</h4>
                            <div class="relative">
                                <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                                    <div id="incentiveProgress" class="progress-bar-animated h-6 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <p class="text-sm mt-3 font-semibold" id="incentiveStatus">LOCKED (Need 90%)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Area Manager Performance Table -->
            <div class="mb-8">
                <div class="card-enhanced rounded-2xl shadow-xl p-8">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-table mr-2 text-blue-600"></i>
                            Area Manager Performance Table
                        </h3>
                        <p class="text-gray-600">Complete 10-day breakdown with targets, daily sales, and achievement percentages</p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="am-table w-full table-auto border-collapse rounded-lg overflow-hidden shadow-sm">
                            <thead>
                                <tr>
                                    <th rowspan="2" class="am-name">Area Manager</th>
                                    <th rowspan="2" class="target-col">10-Day Target</th>
                                    <th colspan="10" class="border-b-2 border-gray-300">Daily Sales (D1 - D10)</th>
                                    <th rowspan="2" class="achievement-col">Total Sales</th>
                                    <th rowspan="2" class="achievement-col">Achievement %</th>
                                </tr>
                                <tr>
                                    <th class="day-sales-cell">D1</th>
                                    <th class="day-sales-cell">D2</th>
                                    <th class="day-sales-cell">D3</th>
                                    <th class="day-sales-cell">D4</th>
                                    <th class="day-sales-cell">D5</th>
                                    <th class="day-sales-cell">D6</th>
                                    <th class="day-sales-cell">D7</th>
                                    <th class="day-sales-cell">D8</th>
                                    <th class="day-sales-cell">D9</th>
                                    <th class="day-sales-cell">D10</th>
                                </tr>
                            </thead>
                            <tbody id="amTableBody">
                                <tr>
                                    <td colspan="14" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>
                                        Loading Area Manager data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Medal Leaderboards -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-red-600 to-red-800 bg-clip-text text-transparent">
                    üèÜ Medal Leaderboards
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Top 5 Outlets by Achievement % -->
                    <div class="card-enhanced rounded-2xl shadow-xl p-8">
                        <h3 class="text-xl font-bold text-center mb-6 text-gray-800">Top 5 Outlets by Achievement %</h3>
                        <div id="topOutletsByPercent" class="space-y-4"></div>
                    </div>
                    
                    <!-- Top 5 Outlets by Sales -->
                    <div class="card-enhanced rounded-2xl shadow-xl p-8">
                        <h3 class="text-xl font-bold text-center mb-6 text-gray-800">Top 5 Outlets by Sales</h3>
                        <div id="topOutletsBySales" class="space-y-4"></div>
                    </div>
                    
                    <!-- Top 3 Area Managers -->
                    <div class="card-enhanced rounded-2xl shadow-xl p-8">
                        <h3 class="text-xl font-bold text-center mb-6 text-gray-800">Top 3 Area Managers</h3>
                        <div id="topAreaManagers" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Incentive System -->
            <div class="mb-8">
                <div class="card-enhanced rounded-2xl shadow-xl p-8">
                    <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">üí∞ Incentive System</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-6">
                            <h4 class="font-bold text-green-800 mb-3 text-lg">Level 1 (‚â•100%)</h4>
                            <ul class="text-sm text-green-700 space-y-2">
                                <li class="flex items-center"><i class="fas fa-check-circle mr-2"></i>Outlet: 2% dari sales</li>
                                <li class="flex items-center"><i class="fas fa-check-circle mr-2"></i>AM: 0.2% dari total sales area</li>
                            </ul>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6">
                            <h4 class="font-bold text-blue-800 mb-3 text-lg">Level 2 (90-99.99%)</h4>
                            <ul class="text-sm text-blue-700 space-y-2">
                                <li class="flex items-center"><i class="fas fa-star mr-2"></i>Outlet: 1% dari sales</li>
                                <li class="flex items-center"><i class="fas fa-star mr-2"></i>AM: 0.1% dari total sales area</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-sm text-gray-600 bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
                            <strong>Syarat:</strong> Target nasional minimal 90% untuk unlock incentive
                        </p>
                    </div>
                </div>
            </div>

            <!-- Outlet Performance Section -->
            <div class="mb-8">
                <div class="card-enhanced rounded-2xl shadow-xl p-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4 md:mb-0">Outlet Performance Tracker</h3>
                        
                        <div class="flex flex-col md:flex-row gap-4">
                            <select id="amFilter" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="">All Area Managers</option>
                            </select>
                            
                            <input type="text" id="searchOutlet" placeholder="Search outlet..." 
                                   class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div id="outletGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
                    
                    <!-- Pagination -->
                    <div class="flex justify-center items-center space-x-4">
                        <button id="prevPage" onclick="changePage(-1)" 
                                class="px-6 py-2 bg-gray-300 rounded-xl hover:bg-gray-400 disabled:opacity-50 transition-all duration-200">
                            <i class="fas fa-chevron-left mr-2"></i>Previous
                        </button>
                        <span id="pageInfo" class="text-gray-600 font-medium"></span>
                        <button id="nextPage" onclick="changePage(1)" 
                                class="px-6 py-2 bg-gray-300 rounded-xl hover:bg-gray-400 disabled:opacity-50 transition-all duration-200">
                            Next<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Performers Alert -->
            <div class="mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Bottom 10 Outlets -->
                    <div class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-2xl p-8 shadow-xl">
                        <h3 class="text-xl font-bold text-red-800 mb-6">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Bottom 10 Outlets - Need Improvement
                        </h3>
                        <div id="bottomOutlets" class="space-y-3"></div>
                        <div class="mt-6 text-sm text-red-700 bg-red-200 rounded-lg p-3">
                            <p><i class="fas fa-lightbulb mr-2"></i> Focus on daily target achievement and customer engagement!</p>
                        </div>
                    </div>
                    
                    <!-- Bottom 3 Area Managers -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-2xl p-8 shadow-xl">
                        <h3 class="text-xl font-bold text-orange-800 mb-6">
                            <i class="fas fa-chart-line mr-2"></i>
                            Bottom 3 Area Managers - Strategic Focus
                        </h3>
                        <div id="bottomAMs" class="space-y-3"></div>
                        <div class="mt-6 text-sm text-orange-700 bg-orange-200 rounded-lg p-3">
                            <p><i class="fas fa-users mr-2"></i> Review regional strategy and support outlet teams!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card-enhanced rounded-2xl shadow-xl p-8">
                        <h3 class="text-xl font-bold mb-6 text-gray-800">Daily National Progress</h3>
                        <div style="height: 300px;">
                            <canvas id="dailyProgressChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card-enhanced rounded-2xl shadow-xl p-8">
                        <h3 class="text-xl font-bold mb-6 text-gray-800">Area Manager Performance</h3>
                        <div style="height: 300px;">
                            <canvas id="amChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 15;
        let filteredOutlets = [];
        let allUsers = [];
        let allOutlets = [];
        let dailyProgressChart = null;
        let amChart = null;

        // Embedded login data from your Google Sheets (EXACT credentials)
        const EMBEDDED_USERS = [
            { name: "ENI KHUZAIMAH", email: "eni.khuzaimah@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "ADE IRMA SEPTIANI AIDHA", email: "ade.irma@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "APRIANA LUMBAN GAOL", email: "apriana.gaol@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "NARTA LENA GINTING", email: "narta.lena@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "HANNA DOLI BR KABAN", email: "hanna.doli@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "JESIKA SILITONGA", email: "jesika.silitonga@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "LINDA NOVAWATI SIHOMBING", email: "linda.sihombing@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "CAMELIA FITRIANI", email: "camelia.fitriani@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "ISMA LESTARI", email: "Isma.lestari@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "NUR ADE ARYANI", email: "nurade.aryani@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "PUTRI WULANDARI", email: "putri.wulandari@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "SITI NURLAILA", email: "siti.nurlaila@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "FUNNA ANINDYA", email: "funna.anindya@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "JULAINI", email: "Julaini@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "SANTI FARIDA YANTI", email: "santi.faridayanti@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "JEPPARIA M SIREGAR", email: "jepparia.siregar@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "LELIANA OKTAVIA SARAGIH", email: "leli.saragih@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "GENY SARASWATI", email: "geny.saraswati@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "BAID SION BR. SINAGA", email: "baid.sion@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "SANNAULI SIAHAAN", email: "sanna.siahaan@apotekalpro.id", status: "Active", role: "Area Manager", password: "Alpro@123" },
            { name: "TOMAS", email: "khoo.ziyu@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "BERNARD", email: "bernard.lee@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "EUGENNE", email: "teo.yinghui@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "YC", email: "yinchen@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "LESTY", email: "rupa.lesty@apotekalpro.id", status: "Active", role: "CHIEF", password: "Alpro@123" },
            { name: "ANTO", email: "tarjo.susianto@apotekalpro.id", status: "Active", role: "BPT", password: "Alpro@123" },
            { name: "SUWAHYU", email: "suwahyu@apotekalpro.id", status: "Active", role: "OPERATION", password: "Alpro@123" },
            { name: "DEVI", email: "devi.purba@apotekalpro.id", status: "Active", role: "STRATEGY", password: "Alpro@123" }
        ];

        // Google Sheets configuration for performance data
        const PERFORMANCE_SHEET_ID = '1TkquW9OszwyWSa-ett8hvGe9JgDdgNtX';
        const PIVOT_AM_SHEET_ID = '1TkquW9OszwyWSa-ett8hvGe9JgDdgNtX';

        function getPerformanceSheetUrl() {
            return `https://docs.google.com/spreadsheets/d/${PERFORMANCE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Update Daily Performance`;
        }

        function getPivotAMSheetUrl() {
            return `https://docs.google.com/spreadsheets/d/${PIVOT_AM_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Pivot Target AM`;
        }

        // Utility function to parse CSV
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim().replace(/^"/, '').replace(/"$/, ''));
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    row.push(current.trim().replace(/^"/, '').replace(/"$/, ''));
                    rows.push(row);
                }
            }
            return rows;
        }

        // Parse Indonesian number format: 1.234.567,89 ‚Üí 1234567.89
        function parseIndonesianNumber(value) {
            if (!value || value === '' || value === '-') return 0;
            
            const cleanValue = String(value)
                .replace(/['"]/g, '')
                .replace(/\s/g, '')
                .trim();
            
            // Handle Indonesian format: 1.234.567,89 ‚Üí 1234567.89
            const standardValue = cleanValue
                .replace(/\./g, '')  // Remove thousand separators (periods)
                .replace(',', '.');  // Convert decimal comma to dot
            
            const numValue = parseFloat(standardValue);
            return isNaN(numValue) ? 0 : numValue;
        }

        // Format number for display in Indonesian format
        function formatRupiah(amount) {
            if (amount === 0) return 'Rp 0';
            
            // Convert to Indonesian format: periods for thousands, commas for decimals
            return 'Rp ' + amount.toLocaleString('id-ID');
        }

        // Format number for display in table (shorter format)
        function formatRupiahShort(amount) {
            if (amount === 0) return '-';
            
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(0) + 'K';
            }
            return amount.toLocaleString('id-ID');
        }

        // Get current campaign day (Aug 9 = Day 1, Aug 10 = Day 2, etc.)
        function getCurrentCampaignDay() {
            const startDate = new Date('2025-08-09');
            const currentDate = new Date();
            
            const diffTime = currentDate - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return Math.max(1, Math.min(10, diffDays)); // Clamp between 1-10
        }

        async function fetchPerformanceData() {
            try {
                console.log('Fetching performance data from:', getPerformanceSheetUrl());
                
                const response = await fetch(getPerformanceSheetUrl());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Raw CSV response (first 500 chars):', text.substring(0, 500));
                
                const rows = parseCSV(text);
                console.log('Total rows parsed:', rows.length);
                
                const outlets = [];
                let grandTotalRow = null;
                
                // Find row 202 specifically (index 201)
                if (rows.length > 201) {
                    grandTotalRow = rows[201]; // Row 202 (0-based index)
                    console.log('Grand Total row (202) found:', grandTotalRow);
                } else {
                    console.warn('Row 202 not found, sheet has only', rows.length, 'rows');
                    // Fallback to last row
                    grandTotalRow = rows[rows.length - 1];
                }
                
                // Parse outlet data (skip header row and Grand Total row)
                for (let i = 1; i < rows.length - 1; i++) {
                    const row = rows[i];
                    if (row.length >= 6 && row[0] && row[0].trim() !== '' && !row[0].toLowerCase().includes('total')) {
                        const outlet = {
                            outlet: row[0] || '',
                            name: row[1] || '',
                            am: row[2] || '',
                            totalTarget: parseIndonesianNumber(row[3]), // Column D
                            dailyTarget: parseIndonesianNumber(row[4])  // Column E
                        };
                        
                        // Parse D1-D10 data - F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y
                        for (let day = 1; day <= 10; day++) {
                            const salesColIndex = 4 + (day * 2); // F=6, H=8, J=10, etc. (1-based becomes F=5, H=7, J=9 in 0-based)
                            const percentColIndex = salesColIndex + 1;
                            
                            // Correct mapping: D1=F(5), D2=H(7), D3=J(9), etc.
                            const actualSalesIndex = 5 + ((day - 1) * 2); // F=5, H=7, J=9, L=11, etc.
                            const actualPercentIndex = actualSalesIndex + 1; // G=6, I=8, K=10, M=12, etc.
                            
                            outlet[`d${day}`] = parseIndonesianNumber(row[actualSalesIndex] || '0');
                            outlet[`d${day}Percent`] = parseIndonesianNumber(row[actualPercentIndex] || '0');
                            
                            console.log(`Outlet ${outlet.outlet} Day ${day}: Sales=${outlet[`d${day}`]} (from col ${actualSalesIndex}), Percent=${outlet[`d${day}Percent`]} (from col ${actualPercentIndex})`);
                        }
                        
                        outlets.push(outlet);
                    }
                }
                
                // Store Grand Total row for Current Achievement calculation
                if (grandTotalRow) {
                    outlets.grandTotalRow = grandTotalRow;
                }
                
                console.log(`Loaded ${outlets.length} outlets`);
                if (outlets.length > 0) {
                    console.log('First outlet sample:', outlets[0]);
                }
                
                return outlets;
                
            } catch (error) {
                console.error('Error fetching performance data:', error);
                return [];
            }
        }

        async function fetchPivotAMData() {
            try {
                const response = await fetch(getPivotAMSheetUrl());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                const rows = parseCSV(text);
                
                const amData = [];
                // Skip header row
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length >= 5 && row[0] && row[0].trim() !== '' && 
                        !row[0].toLowerCase().includes('grand total')) { // FILTER OUT GRAND TOTAL
                        
                        const am = {
                            name: row[0] || '',
                            totalTarget: parseIndonesianNumber(row[1]), // Column B
                            // D1-D10 sales from columns D, E, F, G, H, I, J, K, L, M
                            totalSales: 0,
                            dailySales: []
                        };
                        
                        // Sum all daily sales (columns D through M) and store individual daily values
                        for (let day = 1; day <= 10; day++) {
                            const colIndex = 3 + (day - 1); // D=3, E=4, F=5, etc.
                            const dayValue = parseIndonesianNumber(row[colIndex] || '0');
                            am.totalSales += dayValue;
                            am.dailySales.push(dayValue);
                        }
                        
                        am.achievementPercent = am.totalTarget > 0 ? (am.totalSales / am.totalTarget) * 100 : 0;
                        amData.push(am);
                    }
                }
                
                console.log('Loaded AM data:', amData.length);
                return amData;
            } catch (error) {
                console.error('Error fetching AM data:', error);
                return [];
            }
        }

        // Update AM Performance Table
        async function updateAMTable() {
            try {
                const amData = await fetchPivotAMData();
                const sortedAMData = amData.sort((a, b) => b.achievementPercent - a.achievementPercent);
                
                const tableBody = document.getElementById('amTableBody');
                
                if (sortedAMData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="14" class="text-center py-8 text-gray-500">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                No Area Manager data available
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = sortedAMData.map(am => {
                    // Determine achievement class
                    let achievementClass = 'achievement-poor';
                    if (am.achievementPercent >= 100) {
                        achievementClass = 'achievement-excellent';
                    } else if (am.achievementPercent >= 90) {
                        achievementClass = 'achievement-good';
                    } else if (am.achievementPercent >= 70) {
                        achievementClass = 'achievement-average';
                    }
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="am-name">${am.name}</td>
                            <td class="target-col">${formatRupiahShort(am.totalTarget)}</td>
                            ${am.dailySales.map((sale, index) => `
                                <td class="day-sales-cell ${sale > 0 ? 'font-semibold text-blue-700' : 'text-gray-400'}">
                                    ${formatRupiahShort(sale)}
                                </td>
                            `).join('')}
                            <td class="achievement-col font-bold text-green-700">${formatRupiahShort(am.totalSales)}</td>
                            <td class="achievement-col ${achievementClass}">${am.achievementPercent.toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error updating AM table:', error);
                document.getElementById('amTableBody').innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Error loading Area Manager data
                        </td>
                    </tr>
                `;
            }
        }

        // Calculate Current Achievement from Grand Total row
        function calculateCurrentAchievement() {
            if (!allOutlets.grandTotalRow) {
                console.warn('Grand Total row not available');
                return 0;
            }
            
            let totalAchievement = 0;
            const grandTotalRow = allOutlets.grandTotalRow;
            
            console.log('Calculating Current Achievement from Grand Total row:', grandTotalRow);
            
            // Sum D1-D10 from Grand Total row (columns F, H, J, L, N, P, R, T, V, X)
            for (let day = 1; day <= 10; day++) {
                const colIndex = 5 + ((day - 1) * 2); // F=5, H=7, J=9, L=11, N=13, P=15, R=17, T=19, V=21, X=23
                const dayValue = parseIndonesianNumber(grandTotalRow[colIndex] || '0');
                totalAchievement += dayValue;
                
                console.log(`Grand Total Day ${day} (col ${colIndex}): ${grandTotalRow[colIndex]} ‚Üí ${dayValue}`);
            }
            
            console.log('Total Current Achievement:', totalAchievement);
            return totalAchievement;
        }

        // Calculate Daily Achievement for current day
        function calculateDailyAchievement() {
            if (!allOutlets.grandTotalRow) return 0;
            
            const currentDay = getCurrentCampaignDay();
            const colIndex = 5 + ((currentDay - 1) * 2); // F=5 for Day1, H=7 for Day2, etc.
            
            const dailyValue = parseIndonesianNumber(allOutlets.grandTotalRow[colIndex] || '0');
            console.log(`Daily Achievement Day ${currentDay} (col ${colIndex}): ${allOutlets.grandTotalRow[colIndex]} ‚Üí ${dailyValue}`);
            
            return dailyValue;
        }

        // Login Functions
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            // Show loading state
            loginBtnText.textContent = 'Signing in...';
            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;
            
            try {
                allUsers = EMBEDDED_USERS;
                
                const user = allUsers.find(u => 
                    u.email.toLowerCase().trim() === email.toLowerCase().trim() && 
                    u.password === password && 
                    u.status.toLowerCase() === 'active'
                );
                
                if (user) {
                    currentUser = user;
                    showDashboard();
                } else {
                    showLoginError('Invalid email or password. Please check your credentials.');
                }
            } catch (error) {
                showLoginError('Error connecting to server. Please try again.');
                console.error('Login error:', error);
            }
            
            // Reset button state
            loginBtnText.textContent = 'Login';
            loginSpinner.classList.add('hidden');
            loginBtn.disabled = false;
        });

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        async function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            
            await initializeDashboard();
        }

        function logout() {
            currentUser = null;
            allUsers = [];
            allOutlets = [];
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        async function initializeDashboard() {
            try {
                allOutlets = await fetchPerformanceData();
                filteredOutlets = [...allOutlets];
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                
                startCountdown();
                updateDailyProgress();
                updateNationalProgress();
                updateAMTable(); // Add AM Table update
                updateMedalLeaderboards();
                populateFilters();
                updateOutletDisplay();
                updateBottomPerformers();
                initializeCharts();
                
                setInterval(refreshData, 30000);
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('loadingState').innerHTML = 
                    '<div class="text-center"><p class="text-red-600">Error loading data. Please refresh the page.</p></div>';
            }
        }

        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('animate-spin');
            
            try {
                const newOutlets = await fetchPerformanceData();
                if (newOutlets.length > 0) {
                    allOutlets = newOutlets;
                    applyFilters();
                    updateDailyProgress();
                    updateNationalProgress();
                    updateAMTable(); // Refresh AM Table
                    updateMedalLeaderboards();
                    updateBottomPerformers();
                    updateCharts();
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
            
            refreshIcon.classList.remove('animate-spin');
        }

        function startCountdown() {
            const targetDate = new Date('2025-08-18T23:59:59').getTime();
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = targetDate - now;
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').innerHTML = 
                    `${days}d ${hours}h ${minutes}m ${seconds}s`;
                
                if (distance < 0) {
                    document.getElementById('countdown').innerHTML = "CAMPAIGN ENDED";
                }
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function updateDailyProgress() {
            const currentDay = getCurrentCampaignDay();
            const dailyTarget = 1200000000;
            const dailyAchievement = calculateDailyAchievement();
            const dailyPercent = (dailyAchievement / dailyTarget) * 100;
            
            // Update day label
            const dayLabels = [
                'Day 1 (Aug 9)', 'Day 2 (Aug 10)', 'Day 3 (Aug 11)', 'Day 4 (Aug 12)', 'Day 5 (Aug 13)',
                'Day 6 (Aug 14)', 'Day 7 (Aug 15)', 'Day 8 (Aug 16)', 'Day 9 (Aug 17)', 'Day 10 (Aug 18)'
            ];
            
            document.getElementById('currentDayLabel').textContent = dayLabels[currentDay - 1] || `Day ${currentDay}`;
            document.getElementById('dailyAchievement').textContent = formatRupiah(dailyAchievement);
            document.getElementById('dailyPercent').textContent = `${dailyPercent.toFixed(1)}%`;
            document.getElementById('dailyProgress').style.width = `${Math.min(dailyPercent, 100)}%`;
        }

        function updateNationalProgress() {
            const totalTarget = 12000000000;
            const currentAchievement = calculateCurrentAchievement();
            const achievementPercent = (currentAchievement / totalTarget) * 100;
            const incentiveProgress = Math.min(achievementPercent / 90 * 100, 100);
            
            document.getElementById('currentAchievement').textContent = formatRupiah(currentAchievement);
            document.getElementById('achievementPercent').textContent = `${achievementPercent.toFixed(1)}%`;
            document.getElementById('incentiveProgress').style.width = `${incentiveProgress}%`;
            
            if (achievementPercent >= 90) {
                document.getElementById('incentiveStatus').textContent = 'UNLOCKED! üéâ';
                document.getElementById('incentiveStatus').className = 'text-sm mt-3 font-bold text-green-600';
            } else {
                const needed = 90 - achievementPercent;
                document.getElementById('incentiveStatus').textContent = `LOCKED (Need ${needed.toFixed(1)}% more)`;
                document.getElementById('incentiveStatus').className = 'text-sm mt-3 font-semibold text-red-600';
            }
        }

        async function updateMedalLeaderboards() {
            // Top 5 Outlets by Achievement % (using Column G - Day 1 %)
            const outletsByPercent = [...allOutlets]
                .filter(outlet => outlet.d1Percent > 0) // Only outlets with Day 1 data
                .sort((a, b) => b.d1Percent - a.d1Percent)
                .slice(0, 5);

            const percentContainer = document.getElementById('topOutletsByPercent');
            percentContainer.innerHTML = outletsByPercent.map((outlet, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                const colors = ['gold', 'silver', 'bronze', 'bg-blue-100 border-blue-200', 'bg-green-100 border-green-200'];
                return `
                    <div class="medal-card ${colors[index]} p-4 rounded-xl text-center border-2">
                        <div class="text-3xl mb-2">${medals[index]}</div>
                        <h4 class="font-bold text-sm text-gray-800">${outlet.name}</h4>
                        <p class="text-xs text-gray-600 mb-1">${outlet.am}</p>
                        <p class="text-lg font-bold text-gray-900">${outlet.d1Percent.toFixed(1)}%</p>
                    </div>
                `;
            }).join('');

            // Top 5 Outlets by Sales (using Column F - Day 1 Sales)
            const outletsBySales = [...allOutlets]
                .filter(outlet => outlet.d1 > 0) // Only outlets with Day 1 sales
                .sort((a, b) => b.d1 - a.d1)
                .slice(0, 5);

            const salesContainer = document.getElementById('topOutletsBySales');
            salesContainer.innerHTML = outletsBySales.map((outlet, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                const colors = ['gold', 'silver', 'bronze', 'bg-blue-100 border-blue-200', 'bg-green-100 border-green-200'];
                return `
                    <div class="medal-card ${colors[index]} p-4 rounded-xl text-center border-2">
                        <div class="text-3xl mb-2">${medals[index]}</div>
                        <h4 class="font-bold text-sm text-gray-800">${outlet.name}</h4>
                        <p class="text-xs text-gray-600 mb-1">${outlet.am}</p>
                        <p class="text-sm font-bold text-gray-900">${formatRupiah(outlet.d1)}</p>
                    </div>
                `;
            }).join('');

            // Top 3 Area Managers (from Pivot Target AM sheet)
            try {
                const amData = await fetchPivotAMData();
                const topAMs = amData
                    .sort((a, b) => b.achievementPercent - a.achievementPercent)
                    .slice(0, 3);

                const amContainer = document.getElementById('topAreaManagers');
                amContainer.innerHTML = topAMs.map((am, index) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const colors = ['gold', 'silver', 'bronze'];
                    return `
                        <div class="medal-card ${colors[index]} p-4 rounded-xl text-center border-2">
                            <div class="text-3xl mb-2">${medals[index]}</div>
                            <h4 class="font-bold text-sm text-gray-800">${am.name}</h4>
                            <p class="text-xs text-gray-600 mb-1">Area Manager</p>
                            <p class="text-lg font-bold text-gray-900">${am.achievementPercent.toFixed(1)}%</p>
                            <p class="text-xs text-gray-700">${formatRupiah(am.totalSales)}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error updating AM leaderboard:', error);
            }
        }

        function populateFilters() {
            const amFilter = document.getElementById('amFilter');
            const uniqueAMs = [...new Set(allOutlets.map(outlet => outlet.am))].filter(am => am);
            
            amFilter.innerHTML = '<option value="">All Area Managers</option>' +
                uniqueAMs.map(am => `<option value="${am}">${am}</option>`).join('');

            document.getElementById('amFilter').addEventListener('change', applyFilters);
            document.getElementById('searchOutlet').addEventListener('input', applyFilters);
        }

        function applyFilters() {
            const amFilter = document.getElementById('amFilter').value;
            const searchTerm = document.getElementById('searchOutlet').value.toLowerCase();

            filteredOutlets = allOutlets.filter(outlet => {
                const amMatch = !amFilter || outlet.am === amFilter;
                const searchMatch = !searchTerm || 
                    outlet.name.toLowerCase().includes(searchTerm) || 
                    outlet.outlet.toLowerCase().includes(searchTerm);
                
                return amMatch && searchMatch;
            });

            currentPage = 1;
            updateOutletDisplay();
        }

        function updateOutletDisplay() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageOutlets = filteredOutlets.slice(start, end);

            const outletGrid = document.getElementById('outletGrid');
            outletGrid.innerHTML = pageOutlets.map(outlet => createOutletCard(outlet)).join('');

            updatePagination();
        }

        function createOutletCard(outlet) {
            let totalSales = 0;
            let totalPercent = 0;
            let activeDays = 0;
            
            for (let day = 1; day <= 10; day++) {
                totalSales += outlet[`d${day}`] || 0;
                if (outlet[`d${day}Percent`] > 0) {
                    totalPercent += outlet[`d${day}Percent`];
                    activeDays++;
                }
            }
            
            const avgAchievement = activeDays > 0 ? totalPercent / activeDays : 0;
            
            const performanceClass = avgAchievement >= 100 ? 'performance-excellent' : 
                                   avgAchievement >= 90 ? 'performance-good' : 
                                   avgAchievement >= 70 ? 'performance-average' : 'performance-poor';

            return `
                <div class="outlet-card ${performanceClass} bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-4">
                        <h4 class="font-bold text-base text-gray-900">${outlet.name}</h4>
                        <p class="text-xs text-gray-600">${outlet.outlet}</p>
                        <p class="text-xs text-blue-600 font-medium">${outlet.am}</p>
                    </div>
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        ${[1,2,3,4,5].map(day => {
                            const sales = outlet[`d${day}`] || 0;
                            const percent = outlet[`d${day}Percent`] || 0;
                            const isActive = sales > 0;
                            return `
                                <div class="day-badge ${isActive ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-300 text-gray-500'} 
                                           border-2 rounded-lg p-2 text-center">
                                    <div class="text-xs font-bold">D${day}</div>
                                    <div class="text-xs">
                                        ${isActive ? `${percent.toFixed(1)}%` : '-'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        ${[6,7,8,9,10].map(day => {
                            const sales = outlet[`d${day}`] || 0;
                            const percent = outlet[`d${day}Percent`] || 0;
                            const isActive = sales > 0;
                            return `
                                <div class="day-badge ${isActive ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-300 text-gray-500'} 
                                           border-2 rounded-lg p-2 text-center">
                                    <div class="text-xs font-bold">D${day}</div>
                                    <div class="text-xs">
                                        ${isActive ? `${percent.toFixed(1)}%` : '-'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="border-t pt-4 mt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Total Sales:</span>
                            <span class="font-bold text-green-600">${formatRupiah(totalSales)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Avg Achievement:</span>
                            <span class="font-bold ${avgAchievement >= 100 ? 'text-green-600' : avgAchievement >= 90 ? 'text-blue-600' : 'text-orange-600'}">
                                ${avgAchievement > 0 ? avgAchievement.toFixed(1) + '%' : '-'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredOutlets.length / itemsPerPage);
            
            document.getElementById('pageInfo').textContent = 
                `Page ${currentPage} of ${totalPages} (${filteredOutlets.length} outlets)`;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredOutlets.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updateOutletDisplay();
            }
        }

        function updateBottomPerformers() {
            // Bottom 10 Outlets (based on Day 1 performance)
            const outletsByPerformance = [...allOutlets]
                .filter(outlet => outlet.d1Percent >= 0) // Include all outlets
                .sort((a, b) => a.d1Percent - b.d1Percent)
                .slice(0, 10);

            const bottomOutletsContainer = document.getElementById('bottomOutlets');
            bottomOutletsContainer.innerHTML = outletsByPerformance.map(outlet => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-red-200 shadow-sm">
                    <div>
                        <h5 class="font-semibold text-sm">${outlet.name}</h5>
                        <p class="text-xs text-gray-600">${outlet.am}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-red-600">${outlet.d1Percent > 0 ? outlet.d1Percent.toFixed(1) + '%' : 'No data'}</p>
                    </div>
                </div>
            `).join('');

            // Bottom 3 AMs (from Pivot data)
            fetchPivotAMData().then(amData => {
                const bottomAMs = amData
                    .sort((a, b) => a.achievementPercent - b.achievementPercent)
                    .slice(0, 3);

                const bottomAMsContainer = document.getElementById('bottomAMs');
                bottomAMsContainer.innerHTML = bottomAMs.map(am => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-orange-200 shadow-sm">
                        <div>
                            <h5 class="font-semibold text-sm">${am.name}</h5>
                            <p class="text-xs text-gray-600">Area Manager</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-orange-600">${am.achievementPercent.toFixed(1)}%</p>
                            <p class="text-xs text-gray-500">${formatRupiah(am.totalSales)}</p>
                        </div>
                    </div>
                `).join('');
            });
        }

        function initializeCharts() {
            // Daily Progress Chart - Show Grand Total for each day
            const dailyCtx = document.getElementById('dailyProgressChart').getContext('2d');
            const dailyData = new Array(10).fill(0);
            
            if (allOutlets.grandTotalRow) {
                for (let day = 1; day <= 10; day++) {
                    const colIndex = 5 + ((day - 1) * 2); // F, H, J, L, N, P, R, T, V, X
                    dailyData[day - 1] = parseIndonesianNumber(allOutlets.grandTotalRow[colIndex] || '0');
                }
            }

            dailyProgressChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: ['D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'D9', 'D10'],
                    datasets: [{
                        label: 'Daily Achievement',
                        data: dailyData,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Daily Target',
                        data: Array(10).fill(1200000000),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });

            // Area Manager Performance Chart - UPDATED TO EXCLUDE GRAND TOTAL
            const amCtx = document.getElementById('amChart').getContext('2d');
            
            fetchPivotAMData().then(amData => {
                // Filter out Grand Total (already done in fetchPivotAMData function)
                amChart = new Chart(amCtx, {
                    type: 'doughnut',
                    data: {
                        labels: amData.map(am => am.name),
                        datasets: [{
                            data: amData.map(am => am.totalSales),
                            backgroundColor: [
                                '#dc2626', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6',
                                '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#ec4899',
                                '#6b7280', '#14b8a6', '#f97316', '#8b5cf6', '#06b6d4',
                                '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        function updateCharts() {
            if (dailyProgressChart && allOutlets.grandTotalRow) {
                const dailyData = new Array(10).fill(0);
                for (let day = 1; day <= 10; day++) {
                    const colIndex = 5 + ((day - 1) * 2);
                    dailyData[day - 1] = parseIndonesianNumber(allOutlets.grandTotalRow[colIndex] || '0');
                }
                dailyProgressChart.data.datasets[0].data = dailyData;
                dailyProgressChart.update();
            }

            if (amChart) {
                fetchPivotAMData().then(amData => {
                    // Filter out Grand Total (already done in fetchPivotAMData function)
                    amChart.data.labels = amData.map(am => am.name);
                    amChart.data.datasets[0].data = amData.map(am => am.totalSales);
                    amChart.update();
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Always show login page on load
        });
    </script>

</body>
</html>
